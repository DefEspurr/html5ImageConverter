#!/bin/bash

OUTPUT="outfile"
TMPDIR="/tmp/$$.truecolor.tmp/"

#########################################################################
# OPTIONS                                                               #
#########################################################################
ARGS=`echo $* | tr ' ' '
'`

#
# getArg(): get double dashed argument value
getArg() {
	local NAME="$1"
	local VALIFBLANK="$2"
	
	local VAL=`echo "$ARGS" | grep "\--$1"`
	
	if [ "$VAL" = "" ]
	then
		VAL="$VALIFBLANK"
	else 
		VAL=`echo $VAL | awk -F'=' '{print $2}'`
		if [ "$VAL" = "" ]
		then
			VAL="true"
		fi
	fi
	
	echo $VAL
}

OUTPUT=`getArg 'output' 'outfile'`
MS=`getArg 'ms' '10'`
NOAPNG=`getArg 'no-apng'`
NOGIF=`getArg 'no-gif'`
CSS_CLASS=`getArg 'css-class' $OUTPUT`
CSS_STYLE=`getArg 'css-style' 'modernizr'`
MODERNIZR_SRC=`getArg 'modernizr-src' '../../js/modernizr.custom.29822.js'`
JXR_QUAL=`getArg 'jxr-quality' '80'`
JP2_QUAL=`getArg 'jp2-quality' '80'`

FILEARGS=`echo "$ARGS" | grep -v '\--'`
OPTIONS=`echo "$ARGS" | grep '\--'`
NUM_FRAMES=`echo "$FILEARGS" | wc -l`
FIRST_FILE=`echo "$FILEARGS" | head -1`
DIMS=`identify $FIRST_FILE | awk '{print $3}'`
IMAGE_WIDTH=`echo $DIMS | awk -F"x" '{print $1}'`
IMAGE_HEIGHT=`echo $DIMS | awk -F"x" '{print $2}'`
SPRITE_WIDTH=`expr $IMAGE_WIDTH \* $NUM_FRAMES`
ANIM_LENGTH=`expr $NUM_FRAMES \* $MS`





if [ ! -d "$TMPDIR" ]
then
	mkdir -p "$TMPDIR"
fi

FILE_INDEX=0
for i in $FILEARGS
do
	N=`printf "%04d" $FILE_INDEX`
	cp $i "$TMPDIR"/file$N.png
	FILE_INDEX=`expr $FILE_INDEX + 1`
done

ORIG_DIR="$PWD"
cd "$TMPDIR"

FILES="file*.png"

#.. Convert files to animated apng
if [ "$NOAPNG" = "" ]
then
	apngasm $OUTPUT.unopt.png $FILES $MS 1000
	apngopt $OUTPUT.unopt.png $OUTPUT.png
	
	if [ "$?" != "0" ]
	then
		echo "Error: could not convert to apng" 1>&2
		exit 1
	fi
fi

#.. Convert apng to gif
if [ "$NOGIF" = "" ]
then
	apng2gif $OUTPUT.png

	if [ "$?" != "0" ]
	then
		echo "Error: could not convert to animated GIF." 1>&2
		echo "Please ensure apng2gif is installed" 1>&2
		exit 2
	fi
fi

#.. Convert files to animated webp
#
#   First, convert each frame to a webp
for file in $FILES
do 
	cwebp ${file} -o ${file%.png}.webp
	
	if [ "$?" != "0" ]
	then
		echo "Error: could not convert frame ${file} to webp" 1>&2
		exit 2
	fi
done	

#   Next, convert all frames to animated webp
echo 
echo "Putting webp frames into one animated webp ..."
WEBP_COMMANDLINE='webpmux '

for file in $FILES
do
	FRAME_FILE="${file%.png}.webp"
	WEBP_COMMANDLINE="$WEBP_COMMANDLINE -frame $FRAME_FILE +$MS+0+0+0-b "
done
WEBP_COMMANDLINE="$WEBP_COMMANDLINE -loop 0 -o $OUTPUT.webp"
echo "Using command: "
echo $WEBP_COMMANDLINE
echo

$WEBP_COMMANDLINE

if [ "$?" != "0" ]
then
	echo "Error: Could not convert to webp" 1>&2
	exit 3
fi

# now .. create stitched image of all frames for browsers
# that don't do either APNG or WEBP, but can do CSS
# animations (i.e. IE10)
convert $FILES +append $OUTPUT-stitched.png

# create jxr. First convert to bmp
#convert $OUTPUT-stitched.png  -type TrueColor -colorspace RGB  jxr:$OUTPUT-stitched.tif


##################################################################################
# Convert to JXR.  Note that I could *not* get JxrEncApp to work with anything.
# I tried to convert the stitched PNG to BMP and TIF and then use JxrEncApp to 
# convert that to JXR using variations of this:
#
# JxrEncApp -i $OUTPUT-stitched.tif -o $OUTPUT-stitched.jpeg -c 22 -q `awk "BEGIN{print $JXR_QUAL/100}"`
#
# Unfortunately, it failed silently and wrote a 0-byte JXR file.
# I poured through this manpage:
#
# http://manpages.ubuntu.com/manpages/saucy/man1/JxrEncApp.1.html
#
# However, I could not find a solution.  The issues with this encoder are well
# known by people who have attempted to use it (see this page for more info:
# 
# http://calendar.perfplanet.com/2013/browser-specific-image-formats/
#
# Because of this, I used nconvert:
# 
# http://www.xnview.com/en/nconvert/
#
##################################################################################

nconvert -out jxr -q $JXR_QUAL $OUTPUT-stitched.png

##################################################################################
# Convert to JPEG 2000. Taken from http://www.imagemagick.org/script/jp2.php
# and http://www.imagemagick.org/discourse-server/viewtopic.php?t=22010
#
# Exactimage: http://freecode.com/projects/exact-image
# AntiGrain Geometry: http://www.antigrain.com/download/index.html
# Open JPEG: http://www.openjpeg.org/index.php?menu=download
#            https://code.google.com/p/openjpeg/wiki/DocJ2KCodec
##################################################################################
convert $OUTPUT-stitched.png -alpha Set -define jp2:quality=$JP2_QUAL  $OUTPUT-stitched.jp2
#nconvert -out jp2 -q $JP2_QUAL $OUTPUT-stitched.jp2
# opj_compress -q $JP2_QUAL -i $OUTPUT-stitched.png -o $OUTPUT-stitched.jp2 

# create the stylesheet for it
CSS_HEADER_COMMENT="/*
 * This stylesheet generated by the CSS3 TrueColor Animator v1.0
 * by Zoltan Hawryluk (http://www.useragentman.com). 
 * Latest version of this program is available at
 * https://github.com/zoltan-dulac/css3TrueColorAnimator
 *
 * Generated with the following options: 
`echo "$OPTIONS" | sed "s/^/ * /g"`
 *
 */"
	 
KEYFRAMES="@keyframes "$OUTPUT"play {
	  100% { background-position: -"$SPRITE_WIDTH"px; }
	}
	
	@-webkit-keyframes "$OUTPUT"play {
	  100% { background-position: -"$SPRITE_WIDTH"px; }
	}"
	
	
if [ "$CSS_STYLE" = 'modernizr' ]
then
	echo "$CSS_HEADER_COMMENT
	
	.$CSS_CLASS {
	  width: "$IMAGE_WIDTH"px;
	  height: "$IMAGE_HEIGHT"px;
	}
	
	html.webp .$CSS_CLASS {
	  background: url('./$OUTPUT.webp');
	}
	
	html.apng .$CSS_CLASS {
	  background: url('./$OUTPUT.png');
	}
	
	html.no-apng.no-webp.cssanimations .$CSS_CLASS {
	    background: url('./$OUTPUT-stitched.png') left center;
	    animation: "$OUTPUT"play "$ANIM_LENGTH"ms steps("$NUM_FRAMES") infinite;
	    -webkit-animation: "$OUTPUT"play "$ANIM_LENGTH"ms steps("$NUM_FRAMES") infinite;
	}
	
	html.no-apng.no-webp.jpegxr.cssanimations .$CSS_CLASS {
	    background: url('./$OUTPUT-stitched.jxr') left center;
	}
	
	html.no-apng.no-webp.jpeg2000.cssanimations .$CSS_CLASS {
	    background: url('./$OUTPUT-stitched.jp2') left center;
	}
	
	html.no-apng.no-webp.no-cssanimations .$CSS_CLASS {
	    background: url('./$OUTPUT.gif') left center;
	}
	
	$KEYFRAMES
	" > $OUTPUT.css
else
	echo "$CSS_HEADER_COMMENT
	 
	.$CSS_CLASS {
	  width: "$IMAGE_WIDTH"px;
	  height: "$IMAGE_HEIGHT"px;
	  background: url('./$OUTPUT.webp');
	}
	
	@-moz-document url-prefix() { 
	  .$CSS_CLASS {
	     background: url('./$OUTPUT.png');
	  }
	}
	
	/* IE only */
	@media screen and (min-width:0\0) {
	  .$CSS_CLASS {
	    background: url('./$OUTPUT-stitched.png') left center;
	    animation: "$OUTPUT"play "$ANIM_LENGTH"ms steps("$NUM_FRAMES") infinite;
	  }
	
	}
	
	/* Safari only. */
	@media screen and (-webkit-min-device-pixel-ratio:0) {
	  _::-webkit-full-page-media, _:future, :root .$CSS_CLASS {
	    background: url('./$OUTPUT-stitched.png') left center;
	    -webkit-animation: "$OUTPUT"play "$ANIM_LENGTH"ms steps("$NUM_FRAMES") infinite;
	  }
	}
	
	$KEYFRAMES
	" > $OUTPUT.css
fi

#
# Create sample page
#
echo "<!DOCTYPE html>
<html lang='en'>
  <head>
    
    <title>CSS3 TrueColor Animator Test Sheet</title>
    <meta http-equiv='X-UA-Compatible' content='IE=Edge' />
    <link href='$OUTPUT.css' type='text/css' rel='stylesheet' />
    <style>body { background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAACWBAMAAABp8toqAAAALVBMVEUJCQkAAMAyAGoTExMWFhYdHR0AIUw9GmXAAADAAMAAwAAAwMDAwADAwMD////k4POZAAAAn0lEQVRo3u3OsRFBQRSG0W3B6IAGzGwk0AUt6EOmBK8FqVAJlEAsU4M3ov3XKIA5X7Q7d+aeW+7R7dp2OUfHaIgO+7bdJCoQCAQCgUAgEAgEAoFAIBAIBAKBQCAQCAQCgUAgEAgEAoH8AZLfaW1b5qKY1TzgFLNVng6BQCA/iWw/evY9Zn3z2rcoY+/XZmydQwgEAoFAIBAIBAKBQL4hL8jp+jVpb0RHAAAAAElFTkSuQmCC') 50% 0 no-repeat; background-size: cover;}</style>
    <script src='$MODERNIZR_SRC'></script>
  </head>

  <body>
    <div class='$CSS_CLASS'>
    </div>
  </body>
</html>
" > $OUTPUT.html



# Move created files to original directory and clean up
echo 
echo "Moving files and cleaning up"
mv $OUTPUT.webp $OUTPUT.png $OUTPUT.gif $OUTPUT-stitched.* $OUTPUT.css $OUTPUT.html "$ORIG_DIR"
cd "$ORIG_DIR"
rm -r $TMPDIR
